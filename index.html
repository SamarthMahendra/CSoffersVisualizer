<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interview Journey — Student + Pro Insights</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <!-- Datadog RUM SDK -->
<script src="https://www.datadoghq-browser-agent.com/datadog-rum.js"></script>
<script>
  (function(h,o,u,n,d){
    h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}};
    d=o.createElement(u);d.async=1;d.src='https://www.datadoghq-browser-agent.com/us5/v6/datadog-rum.js';
    n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n);
  })(window,document,'script','https://www.datadoghq-browser-agent.com/us5/v6/datadog-rum.js','DD_RUM');

  window.DD_RUM.onReady(function(){
    window.DD_RUM.init({
      applicationId: '5aca5b04-e27e-415f-a828-456408d700d8',
      clientToken: 'pubff3c239a28fc040fc4dd99ab202f9135',
      site: 'us5.datadoghq.com',
      service: 'jobstats.fyi',
      env: 'prod',
      sessionSampleRate: 100,
      sessionReplaySampleRate: 20,
      trackBfcacheViews: true,
      defaultPrivacyLevel: 'mask-user-input',
    });

    // Optional: start recording user session replays
    window.DD_RUM.startSessionReplayRecording();
  });
</script>

<style>
:root {
  --text: #111;
  --muted: #555;
  --bg: #f8f9fb;
  --card: rgba(255,255,255,0.7);
  --border: rgba(0,0,0,0.08);
  --accent: #0071e3;
  --radius: 18px;
  --blur: 16px;
  --shadow: 0 8px 30px rgba(0,0,0,0.05);
}
@media (prefers-color-scheme: dark) {
  :root {
    --text: #f2f2f2;
    --muted: #9ea5ad;
    --bg: #0c0d10;
    --card: rgba(18,18,22,0.55);
    --border: rgba(255,255,255,0.1);
    --accent: #2997ff;
    --shadow: 0 8px 30px rgba(0,0,0,0.4);
  }
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,-apple-system;background:var(--bg);color:var(--text);line-height:1.6;font-size:15px;padding-bottom:100px}
header{position:sticky;top:0;z-index:100;backdrop-filter:blur(var(--blur));background:rgba(255,255,255,0.6);border-bottom:1px solid var(--border);padding:18px 24px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow)}
@media (prefers-color-scheme:dark){header{background:rgba(18,18,22,0.55)}}
.logo{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#a0d0ff);color:white;font-weight:700;font-size:18px}
h1{font-size:20px;font-weight:600;letter-spacing:-0.3px}
.main{display:grid;grid-template-columns:280px 1fr;gap:24px;max-width:1400px;margin:40px auto;padding:0 24px}
@media(max-width:980px){.main{grid-template-columns:1fr;gap:20px}}
aside{border-radius:var(--radius);background:var(--card);backdrop-filter:blur(var(--blur));border:1px solid var(--border);padding:20px 18px;box-shadow:var(--shadow)}
aside h2{font-size:14px;font-weight:600;margin-bottom:10px}
aside label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
aside input,aside select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.3);color:var(--text);font-size:14px;margin-top:4px}
aside button{margin-top:12px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--accent);color:white;font-weight:600;font-size:14px;cursor:pointer;transition:background 0.3s}
aside button:hover{background:#005bbb}
.company-search-wrapper{margin-top:4px;position:relative}
.company-search{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.3);color:var(--text);font-size:14px}
.company-dropdown{position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:rgba(255,255,255,0.98);border:1px solid var(--border);border-radius:10px;margin-top:4px;z-index:10;display:none;backdrop-filter:blur(10px)}
.company-dropdown.active{display:block}
@media (prefers-color-scheme:dark){.company-dropdown{background:rgba(18,18,22,0.98)}}
.company-option{padding:8px 10px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}
.company-option:last-child{border-bottom:none}
.company-option:hover{background:rgba(0,113,227,0.15)}
.selected-companies{margin-top:10px;min-height:40px;border:1px solid var(--border);border-radius:10px;padding:8px;background:rgba(255,255,255,0.2);display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.selected-companies.empty{justify-content:center;align-items:center}
.selected-companies.empty span{color:var(--muted);font-size:12px}
.company-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;background:var(--accent);color:white;font-size:12px}
.company-tag button{background:none;border:none;color:white;cursor:pointer;padding:0 2px;font-size:14px;font-weight:700}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:24px}
.card{border-radius:var(--radius);background:var(--card);backdrop-filter:blur(var(--blur));border:1px solid var(--border);padding:20px;box-shadow:var(--shadow);transition:transform 0.2s ease,box-shadow 0.3s}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 35px rgba(0,0,0,0.08)}
.card h3{font-size:15px;font-weight:600;margin-bottom:10px;color:var(--muted)}
canvas,svg{width:100%!important;height:280px!important;border-radius:12px;background:rgba(255,255,255,0.2);border:1px solid var(--border)}
.kpi{display:flex;gap:12px;flex-wrap:wrap}
.kpi .stat{border-radius:12px;padding:6px 10px;background:rgba(0,0,0,0.05);font-size:13px;font-weight:500;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px}
th,td{text-align:left;padding:8px 6px;border-bottom:1px solid var(--border)}
thead{font-weight:600;color:var(--muted);background:rgba(255,255,255,0.2)}
tbody tr:hover{background:rgba(255,255,255,0.3)}
.pagination{display:flex;justify-content:center;gap:10px;margin-top:12px}
.pagination button{padding:6px 12px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:13px;cursor:pointer}
.pagination button[disabled]{opacity:0.5;cursor:not-allowed}
</style>
</head>

<body>
<header>
  <div class="logo">IJ</div>
  <h1>Interview Journey — Student + Pro Insights</h1>
</header>

<div class="main">
  <aside>
    <h2>Filters</h2>
    <label>Start Date</label>
    <input type="date" id="startDate">
    <label>End Date</label>
    <input type="date" id="endDate">
    <label>Company</label>
    <div class="company-search-wrapper">
      <input type="text" class="company-search" id="companySearch" placeholder="Search companies...">
      <div class="company-dropdown" id="companyDropdown"></div>
    </div>
    <div class="selected-companies empty" id="selectedCompanies">
      <span>No companies selected</span>
    </div>
    <button id="applyBtn">Apply</button>
  </aside>

  <div>
    <div class="dashboard">
      <div class="card"><h3>1) The Journey — Funnel</h3><canvas id="funnel"></canvas></div>
      <div class="card"><h3>2) Conversion Heatmap</h3><svg id="heatmap"></svg></div>
      <div class="card"><h3>3) Avg Days Between Stages</h3><svg id="timeline"></svg></div>
      <div class="card"><h3>4) Focus Stage</h3><canvas id="barline"></canvas></div>
    </div>

    <div class="card" style="margin-top:24px">
      <h3>Messages</h3>
      <table>
        <thead><tr><th>Time</th><th>Company</th><th>Stage</th><th>Author</th><th>Text</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="pagination">
        <button id="prevPage">Prev</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------ Globals & Helpers ------------ */
const SERVER = window.location.origin;
const $  = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

let META = null;
let DATA = [];
let charts = {};
let currentPage = 1;
let pageSize = 10;

let selectedCompanies = [];
let companyCounts = {};

function destroyChart(id) {
  if (charts[id]) {
    charts[id].destroy();
    charts[id] = null;
  }
}

function shortenStage(stage) {
  // Keep exact labels for now; change here if you want abbreviations
  return stage;
}

/* ------------ Company Picker UI ------------ */
function renderSelectedCompanies() {
  const container = $("#selectedCompanies");
  if (!selectedCompanies.length) {
    container.className = "selected-companies empty";
    container.innerHTML = '<span>No companies selected</span>';
    return;
  }
  container.className = "selected-companies";
  container.innerHTML = selectedCompanies
    .map(
      (c, i) =>
        `<div class="company-tag"><span>${c}</span><button onclick="removeCompany(${i})">×</button></div>`
    )
    .join("");
}

function removeCompany(index) {
  selectedCompanies.splice(index, 1);
  renderSelectedCompanies();
}

function updateCompanyCounts() {
  companyCounts = {};
  DATA.forEach((d) => {
    if (d.company) {
      companyCounts[d.company] = (companyCounts[d.company] || 0) + 1;
    }
  });
}

function renderCompanyDropdown(searchTerm) {
  const dropdown = $("#companyDropdown");
  if (!META || !META.companies) {
    dropdown.classList.remove("active");
    dropdown.innerHTML = "";
    return;
  }

  let list = META.companies.filter(
    (c) =>
      c.toLowerCase().includes((searchTerm || "").toLowerCase()) &&
      !selectedCompanies.includes(c)
  );

  // Sort by activity (desc)
  list = list.sort((a, b) => (companyCounts[b] || 0) - (companyCounts[a] || 0));

  // No search term: show top 10 only
  if (!searchTerm) list = list.slice(0, 10);

  if (!list.length) {
    dropdown.classList.remove("active");
    dropdown.innerHTML = "";
    return;
  }

  dropdown.classList.add("active");
  dropdown.innerHTML = list
    .map(
      (c) =>
        `<div class="company-option" onclick="selectCompany('${c.replace(/'/g, "\\'")}')">${c} <span style="color:var(--muted);font-size:11px">(${companyCounts[c] || 0})</span></div>`
    )
    .join("");
}

function selectCompany(company) {
  if (!selectedCompanies.includes(company)) {
    selectedCompanies.push(company);
    renderSelectedCompanies();
  }
  $("#companySearch").value = "";
  $("#companyDropdown").classList.remove("active");
}

/* ------------ Fetchers ------------ */
async function fetchMeta() {
  const res = await fetch(`${SERVER}/api/meta`);
  META = await res.json();
  renderSelectedCompanies();
}

async function fetchMessages(params = {}) {
  const query = new URLSearchParams(params).toString();
  const res = await fetch(`${SERVER}/api/messages?${query}`);
  const payload = await res.json();
  DATA = payload.items || [];
  updateCompanyCounts();
  renderTable();
  return DATA;
}

/* ------------ Table & Pagination ------------ */
function renderTable() {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";
  if (!DATA.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="color:#999">No messages</td></tr>`;
    $("#pageInfo").textContent = `Page 0 / 0`;
    $("#prevPage").disabled = true;
    $("#nextPage").disabled = true;
    return;
  }

  const start = (currentPage - 1) * pageSize;
  const pageItems = DATA.slice(start, start + pageSize);

  for (const m of pageItems) {
    const tr = document.createElement("tr");
    const t = m.timestamp ? new Date(m.timestamp).toLocaleString() : "—";
    tr.innerHTML = `<td>${t}</td><td>${m.company || ""}</td><td>${m.stage || ""}</td><td>${m.author || ""}</td><td>${m.text || ""}</td>`;
    tbody.appendChild(tr);
  }

  const totalPages = Math.ceil(DATA.length / pageSize) || 1;
  $("#pageInfo").textContent = `Page ${currentPage} / ${totalPages}`;
  $("#prevPage").disabled = currentPage === 1;
  $("#nextPage").disabled = currentPage === totalPages;
}

$("#prevPage").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});
$("#nextPage").addEventListener("click", () => {
  const totalPages = Math.ceil(DATA.length / pageSize) || 1;
  if (currentPage < totalPages) {
    currentPage++;
    renderTable();
  }
});

/* ------------ Charts ------------ */
// 1) Funnel (Chart.js horizontal bar)
function renderFunnel(order, counts) {
  destroyChart("funnel");
  const ctx = document.getElementById("funnel");
  const vals = order.map((s) => counts[s] || 0);
  if (!vals.some((v) => v > 0)) return;

  const labels = order.map((s) => shortenStage(s));
  charts.funnel = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Stage Counts",
          data: vals,
          backgroundColor: "rgba(0,113,227,0.25)",
          borderColor: "#0071e3",
          borderWidth: 2,
          borderRadius: 8,
        },
      ],
    },
    options: {
      indexAxis: "y",
      plugins: { legend: { display: false } },
      scales: {
        x: { beginAtZero: true, ticks: { font: { size: 11, family: "Inter, system-ui, -apple-system" } } },
        y: { ticks: { font: { size: 11, family: "Inter, system-ui, -apple-system" } } },
      },
      animation: { duration: 500 },
    },
  });
}

// 2) Heatmap (D3) with Overall→Reject
function renderHeatmap(sel, companies, transitions, convMat) {
  const svg = d3.select(sel);
  svg.selectAll("*").remove();
  if (!companies.length || !transitions.length) return;

  const margin = { top: 20, right: 80, bottom: 50, left: 100 };
  const W = svg.node().getBoundingClientRect().width;
  const H = svg.node().getBoundingClientRect().height;
  const w = Math.max(0, W - margin.left - margin.right);
  const h = Math.max(0, H - margin.top - margin.bottom);
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const y = d3.scaleBand().domain(companies).range([0, h]).padding(0.15);
  const shortTransitions = transitions.map((t) => {
    if (t === "Overall→Reject") return t;
    const parts = t.split("→");
    return `${shortenStage(parts[0])}→${shortenStage(parts[1])}`;
  });
  const x = d3.scaleBand().domain(shortTransitions).range([0, w]).padding(0.15);
  const color = d3.scaleSequential(d3.interpolateBlues).domain([0, 100]);

  g.append("g")
    .attr("transform", `translate(0,${h})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("transform", "rotate(25)")
    .style("text-anchor", "start")
    .style("font-size", "11px")
    .style("font-family", "Inter, system-ui, -apple-system");

  g.append("g")
    .call(d3.axisLeft(y))
    .selectAll("text")
    .style("font-size", "11px")
    .style("font-family", "Inter, system-ui, -apple-system");

  companies.forEach((c) =>
    transitions.forEach((t, i) => {
      const val = convMat[c]?.[t] ?? 0;
      const shortT = shortTransitions[i];
      g.append("rect")
        .attr("x", x(shortT))
        .attr("y", y(c))
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .attr("rx", 6)
        .attr("fill", color(val))
        .append("title")
        .text(`${c} ${t}: ${val.toFixed(1)}%`);
    })
  );

  // Legend
  const legendWidth = 20;
  const legendHeight = Math.max(40, h);
  const legendX = w + 20;
  const legendScale = d3.scaleLinear().domain([0, 100]).range([legendHeight, 0]);
  const legendAxis = d3.axisRight(legendScale).ticks(5).tickFormat((d) => `${d}%`);

  const defs = svg.append("defs");
  const gradId = "heatmap-gradient";
  const gradient = defs.append("linearGradient").attr("id", gradId).attr("x1", "0%").attr("y1", "100%").attr("x2", "0%").attr("y2", "0%");
  for (let i = 0; i <= 100; i += 10) {
    gradient.append("stop").attr("offset", `${i}%`).attr("stop-color", color(i));
  }

  g.append("rect")
    .attr("x", legendX)
    .attr("y", 0)
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .attr("rx", 4)
    .style("fill", `url(#${gradId})`);

  g.append("g")
    .attr("transform", `translate(${legendX + legendWidth},0)`)
    .call(legendAxis)
    .selectAll("text")
    .style("font-size", "11px")
    .style("font-family", "Inter, system-ui, -apple-system");

  g.append("text")
    .attr("x", legendX + legendWidth / 2)
    .attr("y", -5)
    .style("font-size", "11px")
    .style("font-weight", "600")
    .style("font-family", "Inter, system-ui, -apple-system")
    .attr("text-anchor", "middle")
    .text("Conv %");
}

// 3) Timeline (Avg days between consecutive stages)
// 3) Timeline (Avg days between transitions incl. Overall→Reject as HM→Reject)
function renderTimeline(sel, transitionsForTimeline, stageTimes) {
  const svg = d3.select(sel);
  svg.selectAll("*").remove();
  if (!transitionsForTimeline.length) return;

  const margin = { top: 30, right: 30, bottom: 50, left: 140 };
  const W = svg.node().getBoundingClientRect().width;
  const H = svg.node().getBoundingClientRect().height;
  const w = Math.max(0, W - margin.left - margin.right);
  const h = Math.max(0, H - margin.top - margin.bottom);
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // Build rows for timeline from provided transitions
  const rows = transitionsForTimeline.map((key) => {
    const days = Math.round(stageTimes[key] || 0);
    const label = key === "Overall→Reject" ? key : key.split("→").map(shortenStage).join("→");
    return { key, days, label };
  });

  // If everything is zero, do nothing
  if (!rows.some(r => r.days > 0)) return;

  const y = d3.scaleBand().domain(rows.map(r => r.label)).range([0, h]).padding(0.2);
  const x = d3.scaleLinear()
    .domain([0, Math.max(5, d3.max(rows, r => r.days) || 0) + 5])
    .range([0, w]);

  const color = d3.scaleSequential(d3.interpolateViridis).domain([0, rows.length - 1]);

  g.append("g")
    .call(d3.axisLeft(y))
    .selectAll("text")
    .style("font-size", "11px")
    .style("font-family", "Inter, system-ui, -apple-system");

  const xAxis = g.append("g").attr("transform", `translate(0,${h})`).call(d3.axisBottom(x).ticks(5));
  xAxis.selectAll("text").style("font-size", "11px").style("font-family", "Inter, system-ui, -apple-system");
  xAxis.append("text")
    .attr("x", w / 2)
    .attr("y", 35)
    .attr("fill", "currentColor")
    .style("text-anchor", "middle")
    .style("font-size", "11px")
    .style("font-weight", "600")
    .style("font-family", "Inter, system-ui, -apple-system")
    .text("Days");

  rows.forEach((r, i) => {
    g.append("rect")
      .attr("x", 0)
      .attr("y", y(r.label))
      .attr("width", x(r.days))
      .attr("height", y.bandwidth())
      .attr("rx", 6)
      .attr("fill", color(i))
      .append("title")
      .text(`${r.key}: ${r.days} days`);

    g.append("text")
      .attr("x", x(r.days) + 5)
      .attr("y", y(r.label) + y.bandwidth() / 2 + 4)
      .style("font-size", "11px")
      .style("font-family", "Inter, system-ui, -apple-system")
      .attr("fill", "currentColor")
      .text(`${r.days}d`);
  });
}


// 4) Bar + Line (Count + Cumulative)
function renderBarLine(stages, counts) {
  destroyChart("barline");
  const ctx = document.getElementById("barline");
  const vals = stages.map((s) => counts[s] || 0);
  if (!vals.some((v) => v > 0)) return;

  const cumulative = [];
  let sum = 0;
  for (const v of vals) {
    sum += v;
    cumulative.push(sum);
  }

  const labels = stages.map((s) => shortenStage(s));
  charts.barline = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Count",
          data: vals,
          backgroundColor: "rgba(41,151,255,0.3)",
          borderColor: "#2997ff",
          borderWidth: 2,
          borderRadius: 8,
          yAxisID: "y",
        },
        {
          label: "Cumulative",
          type: "line",
          data: cumulative,
          borderColor: "#ff9500",
          borderWidth: 3,
          fill: false,
          tension: 0.3,
          yAxisID: "y1",
        },
      ],
    },
    options: {
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: { font: { size: 11, family: "Inter, system-ui, -apple-system" } },
        },
      },
      scales: {
        x: { ticks: { font: { size: 11, family: "Inter, system-ui, -apple-system" } } },
        y: {
          beginAtZero: true,
          position: "left",
          title: { display: true, text: "Count", font: { size: 11, family: "Inter, system-ui, -apple-system" } },
          ticks: { font: { size: 11, family: "Inter, system-ui, -apple-system" } },
        },
        y1: {
          beginAtZero: true,
          position: "right",
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Cumulative", font: { size: 11, family: "Inter, system-ui, -apple-system" } },
          ticks: { font: { size: 11, family: "Inter, system-ui, -apple-system" } },
        },
      },
      animation: { duration: 500 },
    },
  });
}

/* ------------ Dashboard Refresh ------------ */
async function refresh() {
  const start = $("#startDate").value;
  const end = $("#endDate").value;
  const companies = selectedCompanies.join(",");

  const params = { start, end, companies };
  const data = await fetchMessages(params);

  const stages = META.stages || [];
  // Stage counts
  const counts = Object.fromEntries(stages.map((s) => [s, 0]));
  data.forEach((d) => {
    if (counts[d.stage] != null) counts[d.stage]++;
  });

  // Companies for heatmap
  const baseCompanies = selectedCompanies.length ? selectedCompanies : META.companies || [];
  const compCounts = {};
  baseCompanies.forEach((c) => (compCounts[c] = 0));
  data.forEach((d) => {
    if (compCounts[d.company] != null) compCounts[d.company]++;
  });
  const top8Companies = Object.entries(compCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 8)
    .map(([c]) => c);

  // Conversion matrix: stage→next-stage (skip Reject as a “to”) + Overall→Reject
  const convMat = {};
  const applications = {}; // key: `${company}|${author}` -> [{stage, ts}]
  data.forEach((d) => {
    const key = `${d.company}|${d.author}`;
    (applications[key] ||= []).push({
      stage: d.stage,
      ts: d.timestamp ? new Date(d.timestamp).getTime() : null,
    });
  });

  // Stage counts per company for simple ratio calc
  const perCompanyStageCounts = {};
  top8Companies.forEach((c) => (perCompanyStageCounts[c] = Object.fromEntries(stages.map((s) => [s, 0]))));
  data.forEach((d) => {
    if (perCompanyStageCounts[d.company] && perCompanyStageCounts[d.company][d.stage] != null) {
      perCompanyStageCounts[d.company][d.stage] += 1;
    }
  });

  // Stage→next-stage (no ...→Reject)
  top8Companies.forEach((c) => {
    convMat[c] = {};
    for (let i = 0; i < stages.length - 1; i++) {
      const from = stages[i];
      const to = stages[i + 1];
      if ((to || "").toLowerCase() === "reject") continue;
      const fromCount = perCompanyStageCounts[c][from] || 0;
      const toCount = perCompanyStageCounts[c][to] || 0;
      const pct = fromCount > 0 ? (toCount / fromCount) * 100 : 0;
      convMat[c][`${from}→${to}`] = pct;
    }
  });

  // Overall→Reject
  const appsByCompany = {};
  top8Companies.forEach((c) => (appsByCompany[c] = new Set()));
  Object.keys(applications).forEach((key) => {
    const [company] = key.split("|");
    if (appsByCompany[company]) appsByCompany[company].add(key);
  });
  top8Companies.forEach((c) => {
    const keys = Array.from(appsByCompany[c] || []);
    if (!keys.length) {
      convMat[c]["Overall→Reject"] = 0;
      return;
    }
    let rejected = 0;
    keys.forEach((k) => {
      const stagesSeen = new Set((applications[k] || []).map((x) => x.stage).filter(Boolean));
      if (stagesSeen.has("Reject")) rejected += 1;
    });
    convMat[c]["Overall→Reject"] = (rejected / keys.length) * 100;
  });

  // ---- Avg days between consecutive stages (earliest timestamp per stage) ----
const transitionDays = {};
stages.slice(0, -1).forEach((s, i) => {
  const to = stages[i + 1];
  transitionDays[`${s}→${to}`] = [];
});

// Build per-application earliest timestamps
const appEarliest = {};
Object.entries(applications).forEach(([key, msgs]) => {
  const stageMap = {};
  msgs.forEach((m) => {
    if (!m.stage || !Number.isFinite(m.ts)) return;
    if (!(m.stage in stageMap) || m.ts < stageMap[m.stage]) {
      stageMap[m.stage] = m.ts;
    }
  });
  appEarliest[key] = stageMap;
});

// Fill consecutive stage deltas
Object.values(appEarliest).forEach((stageMap) => {
  for (let i = 0; i < stages.length - 1; i++) {
    const from = stages[i], to = stages[i + 1];
    if (stageMap[from] != null && stageMap[to] != null) {
      const days = (stageMap[to] - stageMap[from]) / (1000 * 60 * 60 * 24);
      if (Number.isFinite(days) && days >= 0) transitionDays[`${from}→${to}`].push(days);
    }
  }
});

// ---- HM→Reject as Overall→Reject ----
const HM = "HM";
const REJECT = "Reject";
const hmToRejectDays = [];
Object.values(appEarliest).forEach((stageMap) => {
  if (stageMap[HM] != null && stageMap[REJECT] != null) {
    const days = (stageMap[REJECT] - stageMap[HM]) / (1000 * 60 * 60 * 24);
    if (Number.isFinite(days) && days >= 0) hmToRejectDays.push(days);
  }
});

const stageTimes = {};
Object.keys(transitionDays).forEach((k) => {
  const arr = transitionDays[k];
  stageTimes[k] = arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
});
stageTimes["Overall→Reject"] = hmToRejectDays.length
  ? hmToRejectDays.reduce((a, b) => a + b, 0) / hmToRejectDays.length
  : 0;

// ---- Transitions for visuals ----
const transitions = stages
  .slice(0, -1)
  .filter((_, i) => (stages[i + 1] || "").toLowerCase() !== "reject")
  .map((_, i) => `${stages[i]}→${stages[i + 1]}`);

const transitionsWithOverallReject = [...transitions, "Overall→Reject"];

// ---- Render ----
renderFunnel(stages, counts);
renderHeatmap("#heatmap", top8Companies, transitionsWithOverallReject, convMat);
renderTimeline("#timeline", transitionsWithOverallReject, stageTimes);  // <-- updated
renderBarLine(stages, counts);

}

/* ------------ Init ------------ */
async function initDashboard() {
  // Default range: last 3 months
  const today = new Date();
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(today.getMonth() - 3);

  const fmt = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  };

  $("#startDate").value = fmt(threeMonthsAgo);
  $("#endDate").value = fmt(today);

  await fetchMeta();
  await fetchMessages();
  await refresh();

  // Company search interactions
  $("#companySearch").addEventListener("input", (e) => renderCompanyDropdown(e.target.value));
  $("#companySearch").addEventListener("focus", (e) => renderCompanyDropdown(e.target.value));
  $("#applyBtn").addEventListener("click", () => {
    currentPage = 1;
    refresh();
  });

  // Close dropdown on outside click
  document.addEventListener("click", (e) => {
    if (!e.target.closest(".company-search-wrapper")) {
      $("#companyDropdown").classList.remove("active");
    }
  });
}

window.addEventListener("DOMContentLoaded", initDashboard);

// Expose for inline onclick
window.removeCompany = removeCompany;
window.selectCompany = selectCompany;
</script>

</body>
</html>
