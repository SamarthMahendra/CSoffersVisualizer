<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JobStats.fyi ‚Äî Interview Analytics Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- SEO Meta Tags -->
<meta name="description" content="Real-time insights into CS/intern/new-grad interview processes. Track funnel, conversion, and company-level hiring activity from community data.">
<meta name="keywords" content="CS interviews, new grad, internship, interview funnel, tech recruiting, jobstats, jobstats.fyi, interview analytics, interview stages, hiring trends">
<meta name="author" content="JobStats.fyi">
<meta name="robots" content="index, follow">
<meta name="googlebot" content="index, follow">
<link rel="canonical" href="https://www.jobstats.fyi/">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.jobstats.fyi/">
<meta property="og:title" content="JobStats.fyi ‚Äî Interview Analytics Dashboard">
<meta property="og:description" content="See where CS students and new grads are in the interview funnel across 1,400+ companies.">
<meta property="og:site_name" content="JobStats.fyi">
<meta property="og:locale" content="en_US">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="JobStats.fyi ‚Äî Interview Analytics Dashboard">
<meta name="twitter:description" content="Real-time interview funnel, conversion, and company activity analytics collected from CS career communities.">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter', 'system-ui', 'sans-serif'],
        },
        colors: {
          // You can define custom colors here if needed
          // e.g., 'accent': '#2997ff'
        }
      },
    },
    plugins: [
      require('@tailwindcss/forms'),
    ],
  }
</script>

<style>
  /* Small custom style for Chart.js responsiveness */
  canvas, svg {
    width: 100% !important;
    height: auto !important;
  }

  /* Custom styles for D3 elements (which don't use Tailwind classes) */
  #heatmap text, #timeline text {
    font-size: 11px;
    font-family: 'Inter', sans-serif;
    fill: currentcolor;
  }

  /* Custom scrollbar for company lists */
  .company-cards-container::-webkit-scrollbar {
    width: 6px;
  }
  .company-cards-container::-webkit-scrollbar-track {
    background: #f1f5f9; /* slate-100 */
    border-radius: 10px;
  }
  .company-cards-container::-webkit-scrollbar-thumb {
    background: #94a3b8; /* slate-400 */
    border-radius: 10px;
  }
  .company-cards-container::-webkit-scrollbar-thumb:hover {
    background: #64748b; /* slate-500 */
  }

/* ===== OLD CSS FOR HEADER ===== */
:root {
  --page-bg: radial-gradient(circle at top, #f5f7fb 0%, #e7ebf3 32%, #dce1eb 60%, #ced4e0 100%);
  --surface: rgba(255, 255, 255, 0.65);
  --surface-solid: #ffffff;
  --surface-dark: rgba(18, 18, 22, 0.55);
  --border: rgba(11, 15, 25, 0.08);
  --radius-lg: 20px;
  --radius-md: 14px;
  --shadow-lg: 0 18px 40px rgba(15, 23, 42, 0.13);
  --shadow-md: 0 12px 24px rgba(15, 23, 42, 0.08);
  --accent: #2997ff;
  --accent-soft: rgba(41, 151, 255, 0.06);
  --text: #0f172a;
  --muted: #6b7280;
  --muted-2: #94a3b8;
  --card-gap: 18px;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--page-bg);
  min-height: 100vh;
  color: var(--text);
  line-height: 1.55;
  letter-spacing: -0.01em;
}

/* ===== TOP BAR ===== */
.topbar {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(16px);
  background: rgba(245, 247, 251, 0.25);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 20px 14px 20px;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 180px;
}

.app-logo {
  width: 38px;
  height: 38px;
  border-radius: 16px;
  background: radial-gradient(circle, #2997ff 0%, #0479de 40%, #035d9f 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  color: #fff;
  font-weight: 700;
  font-size: 16px;
  letter-spacing: -0.04em;
  box-shadow: 0 12px 26px rgba(0, 113, 227, 0.35);
}
.app-title {
  display:flex;
  flex-direction:column;
  gap:2px;
}
.app-title h1 {
  font-size: 15px;
  font-weight: 600;
  margin: 0;
}
.app-title small {
  font-size: 11.5px;
  color: var(--muted);
}

.topbar-center {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.topbar-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.4);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12.5px;
  color: var(--muted);
  cursor: pointer;
}

.topbar-pill strong {
  color: var(--text);
  font-weight: 600;
  font-size: 12.5px;
}

.topbar-right {
  display:flex;
  align-items:center;
  gap:10px;
}

.data-info-btn {
  margin:0;
  display:flex;
  align-items:center;
  gap:4px;
  padding:6px 12px;
  border-radius: 12px;
  background: rgba(41, 151, 255, 0.08);
  border:1px solid rgba(41,151,255,0.2);
  cursor:pointer;
  font-size:12px;
  color:var(--text);
  transition: all .2s;
}

.data-info-btn:hover {
  background: rgba(41,151,255,0.15);
  transform: translateY(-1px);
}

.viewer-counter {
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius: 999px;
  background: rgba(0,113,227,0.08);
  border:1px solid rgba(0,113,227,0.15);
  cursor: default;
}
.viewer-icon {
  font-size: 14px;
}
.viewer-count {
  font-weight: 700;
  color: var(--accent);
}
.viewer-label {
  font-size: 11.5px;
  color: var(--muted);
}

@media (max-width: 960px) {
  .topbar-center {
    display:none;
  }
  .topbar {
    gap:10px;
    justify-content: space-between;
  }
  .data-info-btn span.data-info-text {
    display:none;
  }
}
</style>

<!-- Datadog RUM -->
<script>
(function(h,o,u,n,d){
  h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}};
  d=o.createElement(u);d.async=1;d.src='https://www.datadoghq-browser-agent.com/us5/v6/datadog-rum.js';
  n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n);
})(window,document,'script','https://www.datadoghq-browser-agent.com/us5/v6/datadog-rum.js','DD_RUM');

window.DD_RUM.onReady(function() {
  let visitorId = localStorage.getItem("visitor_id");
  if (!visitorId) {
    visitorId = "anon_" + Math.random().toString(36).substring(2, 10) + "_" + Date.now();
    localStorage.setItem("visitor_id", visitorId);
  }
  const lastVisit = localStorage.getItem("last_visit");
  const now = Date.now();
  const isReturning = !!lastVisit;
  localStorage.setItem("last_visit", now);

  window.DD_RUM.init({
    clientToken: 'pubff3c239a28fc040fc4dd99ab202f9135',
    applicationId: '5aca5b04-e27e-415f-a828-456408d700d8',
    site: 'us5.datadoghq.com',
    service: 'jobstats.fyi',
    env: 'prod',
    sessionSampleRate: 100,
    sessionReplaySampleRate: 20,
    defaultPrivacyLevel: 'mask-user-input',
  });

  window.DD_RUM.setGlobalContextProperty('visitor_id', visitorId);
  window.DD_RUM.setGlobalContextProperty('is_returning', isReturning);
  window.DD_RUM.setGlobalContextProperty(
    'theme',
    window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  );
  window.DD_RUM.setGlobalContextProperty(
    'device_type',
    /Mobi/.test(navigator.userAgent) ? 'mobile' : 'desktop'
  );

  window.DD_RUM.addAction("page_loaded", {
    visitor_id: visitorId,
    is_returning: isReturning,
    timestamp: new Date().toISOString(),
  });
});
</script>

</head>
<body>

<div class="dashboard-wrapper max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="app-shell flex flex-col min-h-screen">

  <!-- ===== TOPBAR ===== -->
<header class="topbar">
  <div class="topbar-left">
    <div class="app-logo">JS</div>
    <div class="app-title">
      <h1>JobStats.fyi</h1>
      <small>Interview & hiring signals</small>
    </div>
  </div>
  <div class="topbar-center">
    <div class="topbar-pill">
      <span>üìÖ</span>
      <span>Filters active</span>
    </div>
    <div class="topbar-pill">
      <span>üß™</span>
      <span>NG + Intern</span>
    </div>
    <div class="topbar-pill">
      <span>üì°</span>
      <span>Realtime data</span>
    </div>
  </div>
  <div class="topbar-right">
    <button class="data-info-btn" id="dataInfoBtn">
  <span class="data-info-icon">üìä</span>
  <span class="data-info-text">How we collect data</span>
</button>
    <div class="viewer-counter" id="viewerCounter" title="People seeing this page right now">
      <span class="viewer-icon">üëÅ</span>
      <span class="viewer-count" id="viewerCount">-</span>
      <span class="viewer-label">online</span>
    </div>
  </div>
</header>

  <!-- ===== MAIN ===== -->
  <main class="main-shell grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4 py-4 lg:gap-6 lg:py-6">

    <!-- SIDEBAR / FILTERS -->
    <aside class="sidebar bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75 h-max flex flex-col gap-5 sticky top-24">
      <div class="sidebar-title text-sm font-semibold text-slate-800 uppercase tracking-wider">Filters</div>

      <div>
        <div class="filter-label text-sm font-medium text-slate-700 mb-2">Quick range</div>
        <div class="date-presets grid grid-cols-2 gap-2">
          <button class="date-preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 transition-all data-[active='true']:bg-blue-600 data-[active='true']:text-white data-[active='true']:shadow-md" data-days="7" data-active="false">Last 7d</button>
          <button class="date-preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 transition-all data-[active='true']:bg-blue-600 data-[active='true']:text-white data-[active='true']:shadow-md" data-days="30" data-active="false">Last 30d</button>
          <button class="date-preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 transition-all data-[active='true']:bg-blue-600 data-[active='true']:text-white data-[active='true']:shadow-md" data-days="90" data-active="true">Last 3m</button>
          <button class="date-preset-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 transition-all data-[active='true']:bg-blue-600 data-[active='true']:text-white data-[active='true']:shadow-md" data-days="180" data-active="false">Last 6m</button>
        </div>
      </div>

      <div>
        <div class="filter-label text-sm font-medium text-slate-700 mb-2">Start date</div>
        <input type="date" id="startDate" class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
      </div>

      <div>
        <div class="filter-label text-sm font-medium text-slate-700 mb-2">End date</div>
        <input type="date" id="endDate" class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
      </div>

      <div>
        <div class="filter-label text-sm font-medium text-slate-700 mb-2">Company</div>
        <div class="company-search-wrapper relative">
          <input type="text" class="company-search w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" id="companySearch" placeholder="Search companies‚Ä¶">
          <div class="company-dropdown absolute top-full left-0 right-0 mt-1 bg-white border border-slate-300 rounded-lg shadow-xl max-h-60 overflow-y-auto z-10 hidden" id="companyDropdown"></div>
        </div>
        <div class="selected-companies empty mt-2 flex flex-wrap gap-2 border border-dashed border-slate-300 rounded-lg p-2 min-h-[40px]" id="selectedCompanies">
          <span class="text-xs text-slate-500 p-1">No companies selected</span>
        </div>
      </div>

      <div>
        <div class="filter-label text-sm font-medium text-slate-700 mb-2">Job type</div>
        <div class="job-type-checkboxes flex flex-col gap-2">
          <label class="checkbox-wrapper flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
            <input type="checkbox" id="newGradCheckbox" checked class="rounded border-slate-300 text-blue-600 shadow-sm focus:ring-blue-500">
            <span>New grad</span>
          </label>
          <label class="checkbox-wrapper flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
            <input type="checkbox" id="internCheckbox" checked class="rounded border-slate-300 text-blue-600 shadow-sm focus:ring-blue-500">
            <span>Internship</span>
          </label>
        </div>
      </div>

      <button id="applyBtn" class="w-full bg-gradient-to-br from-blue-500 to-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg hover:from-blue-600 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        Apply filters
      </button>
    </aside>

    <!-- CONTENT -->
    <section class="content-area flex flex-col gap-4 lg:gap-6 min-w-0">

      <!-- METRICS STRIP -->
      <div class="metrics-banner grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="metric-card bg-white p-4 rounded-xl shadow-lg border border-slate-200/75 flex flex-col gap-1 relative overflow-hidden">
          <div class="metric-label text-xs font-medium text-slate-500 uppercase tracking-wider">Total companies</div>
          <div class="metric-value text-3xl font-bold text-blue-600" id="totalCompanies">-</div>
          <div class="metric-subtle text-xs text-slate-400">from community sources</div>
          <div class="absolute -top-4 -right-8 w-24 h-24 rounded-full bg-blue-500/5 opacity-50"></div>
        </div>
        <div class="metric-card bg-white p-4 rounded-xl shadow-lg border border-slate-200/75 flex flex-col gap-1 relative overflow-hidden">
          <div class="metric-label text-xs font-medium text-slate-500 uppercase tracking-wider">Total candidates</div>
          <div class="metric-value text-3xl font-bold text-blue-600" id="totalCandidates">-</div>
          <div class="metric-subtle text-xs text-slate-400">unique authors</div>
          <div class="absolute -top-4 -right-8 w-24 h-24 rounded-full bg-blue-500/5 opacity-50"></div>
        </div>
        <div class="metric-card bg-white p-4 rounded-xl shadow-lg border border-slate-200/75 flex flex-col gap-1 relative overflow-hidden">
          <div class="metric-label text-xs font-medium text-slate-500 uppercase tracking-wider">Total submissions</div>
          <div class="metric-value text-3xl font-bold text-blue-600" id="totalSubmissions">-</div>
          <div class="metric-subtle text-xs text-slate-400">stage updates</div>
          <div class="absolute -top-4 -right-8 w-24 h-24 rounded-full bg-blue-500/5 opacity-50"></div>
        </div>
        <div class="metric-card bg-white p-4 rounded-xl shadow-lg border border-slate-200/75 flex flex-col gap-1 relative overflow-hidden">
          <div class="metric-label text-xs font-medium text-slate-500 uppercase tracking-wider">Last updated</div>
          <div class="metric-value text-3xl font-bold text-blue-600" id="lastUpdated">-</div>
          <div class="metric-subtle text-xs text-slate-400">refreshed daily</div>
          <div class="absolute -top-4 -right-8 w-24 h-24 rounded-full bg-blue-500/5 opacity-50"></div>
        </div>
      </div>

      <!-- DASHBOARD GRID -->
      <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 relative">
        <div class="card bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">1) Stage funnel</div>
            <div class="card-sub text-sm text-slate-500">Progression through OA ‚Üí phone ‚Üí onsite ‚Üí offer</div>
          </div>
          <div class="funnel-card" id="funnelContainer">
            <div id="funnelRows" class="flex flex-col gap-2"></div>
            <div class="funnel-scale" id="funnelScale"></div>
          </div>
        </div>

        <div class="card bg-white p-5 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">2) Conversion heatmap</div>
            <div class="card-sub text-sm text-slate-500">Top companies √ó stage-to-stage win rates</div>
          </div>
          <svg id="heatmap" class="aspect-[16/9]"></svg>
        </div>

        <div class="card bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">5) Top OAs this week</div>
            <div class="card-sub text-sm text-slate-500">Companies sending the most OAs now</div>
          </div>
          <div id="topOACompanies" class="company-cards-container max-h-[260px] overflow-y-auto flex flex-col gap-2 pr-2"></div>
        </div>

        <div class="card bg-white p-5 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">6) Top offers this week</div>
            <div class="card-sub text-sm text-slate-500">Who‚Äôs actually closing candidates</div>
          </div>
          <div id="topOfferCompanies" class="company-cards-container max-h-[260px] overflow-y-auto flex flex-col gap-2 pr-2"></div>
        </div>

        <div class="card bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">3) Avg days between stages</div>
            <div class="card-sub text-sm text-slate-500">How long candidates wait to progress</div>
          </div>
          <svg id="timeline" class="aspect-[16/9]"></svg>
        </div>

        <div class="card bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">4) Stage focus</div>
            <div class="card-sub text-sm text-slate-500">Counts + cumulative across funnel</div>
          </div>
          <canvas id="barline" class="aspect-[16/9]"></canvas>
        </div>


        <div class="card card-full lg:col-span-2 bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">7) Hiring season trends (past 6 months)</div>
            <div class="card-sub text-sm text-slate-500">Companies vs global average ‚Äî smoothed</div>
          </div>
          <canvas id="hiringTrends" class="aspect-[3/1]"></canvas>
        </div>

        <div class="card card-full lg:col-span-2 bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-200/75">
          <div class="card-header mb-4">
            <div class="card-title font-semibold text-slate-800">Recent messages</div>
            <div class="card-sub text-sm text-slate-500">Latest interview reports from your sources</div>
          </div>
          <div class="local-filters grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
            <input id="searchCompany" type="text" placeholder="Search company..." class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" />
            <input id="searchAuthor" type="text" placeholder="Search author..." class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" />
            <input id="searchStage" type="text" placeholder="Search stage..." class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" />
          </div>
          <div class="table-wrapper overflow-x-auto border border-slate-200 rounded-lg">
            <table class="w-full min-w-[600px]">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Time</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Company</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Stage</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Author</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Text</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                <!-- Rows will be injected by JS -->
              </tbody>
            </table>
          </div>
          <div class="pagination flex gap-2 justify-end items-center mt-4">
            <button id="prevPage" class="px-3 py-1 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
            <span id="pageInfo" class="text-sm text-slate-600 px-2"></span>
            <button id="nextPage" class="px-3 py-1 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
          </div>
        </div>

        <!-- Refresh Loader -->
        <div id="refreshLoader" class="refresh-loader hidden absolute inset-0 bg-slate-900/10 backdrop-blur-sm flex flex-col justify-center items-center z-20 rounded-xl transition-opacity">
          <div class="spinner w-12 h-12 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
          <p class="text-slate-700 font-medium">Refreshing data‚Ä¶</p>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Feedback Button -->
<button class="feedback-btn fixed bottom-6 right-6 z-50 bg-gradient-to-br from-blue-500 to-blue-700 text-white font-semibold py-3 px-5 rounded-full shadow-xl hover:shadow-2xl hover:from-blue-600 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center gap-2" id="feedbackBtn" title="Send feedback">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
  Feedback
</button>

<!-- Feedback Modal -->
<div class="feedback-modal hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" id="feedbackModal">
  <div class="modal-panel bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="modal-header flex justify-between items-center p-5 border-b border-slate-200">
      <span class="modal-title text-lg font-semibold text-slate-800">Share your feedback</span>
      <button class="modal-close text-slate-400 hover:text-slate-600" id="feedbackClose">&times;</button>
    </div>
    <div class="modal-body p-5">
      <form id="feedbackForm" class="space-y-4">
        <div>
          <label for="feedbackRating" class="block text-sm font-medium text-slate-700 mb-2">How was your experience?</label>
          <div class="rating-buttons grid grid-cols-5 gap-2">
            <button type="button" class="rating-btn text-3xl p-2 rounded-lg border-2 border-transparent bg-slate-100 hover:border-blue-400 data-[selected='true']:border-blue-500 data-[selected='true']:bg-blue-50" data-rating="1" data-selected="false">üòû</button>
            <button type="button" class="rating-btn text-3xl p-2 rounded-lg border-2 border-transparent bg-slate-100 hover:border-blue-400 data-[selected='true']:border-blue-500 data-[selected='true']:bg-blue-50" data-rating="2" data-selected="false">üòê</button>
            <button type="button" class="rating-btn text-3xl p-2 rounded-lg border-2 border-transparent bg-slate-100 hover:border-blue-400 data-[selected='true']:border-blue-500 data-[selected='true']:bg-blue-50" data-rating="3" data-selected="false">üôÇ</button>
            <button type="button" class="rating-btn text-3xl p-2 rounded-lg border-2 border-transparent bg-slate-100 hover:border-blue-400 data-[selected='true']:border-blue-500 data-[selected='true']:bg-blue-50" data-rating="4" data-selected="false">üòä</button>
            <button type="button" class="rating-btn text-3xl p-2 rounded-lg border-2 border-transparent bg-slate-100 hover:border-blue-400 data-[selected='true']:border-blue-500 data-[selected='true']:bg-blue-50" data-rating="5" data-selected="false">ü§©</button>
          </div>
          <input type="hidden" id="feedbackRating" name="rating">
        </div>

        <div>
          <label for="feedbackText" class="block text-sm font-medium text-slate-700 mb-2">Your feedback *</label>
          <textarea id="feedbackText" name="feedback" rows="5" required placeholder="Tell us what to improve, or what data you expected but didn‚Äôt see..." class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
        </div>

        <div>
          <label for="feedbackEmail" class="block text-sm font-medium text-slate-700 mb-2">Email (optional)</label>
          <input type="email" id="feedbackEmail" name="email" placeholder="you@example.com" class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>

        <div class="feedback-actions flex gap-3 pt-2">
          <button type="button" class="feedback-cancel w-full py-2.5 px-4 rounded-lg bg-slate-100 text-slate-700 font-medium hover:bg-slate-200 transition-all" id="feedbackCancel">Cancel</button>
          <button type="submit" class="feedback-submit w-full py-2.5 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-all">Send</button>
        </div>

        <div class="feedback-status hidden text-sm p-3 rounded-lg" id="feedbackStatus"></div>
      </form>
    </div>
  </div>
</div>

<!-- Data Methodology Modal -->
<div class="data-modal hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" id="dataModal">
  <div class="modal-panel bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="modal-header flex justify-between items-center p-5 border-b border-slate-200">
      <span class="modal-title text-lg font-semibold text-slate-800">About our data</span>
      <button class="modal-close text-slate-400 hover:text-slate-600" id="dataClose">&times;</button>
    </div>
    <div class="modal-body p-5 space-y-5 text-sm text-slate-600">
      <div class="data-section">
        <h3 class="text-base font-semibold text-slate-800 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
          Data Sources
        </h3>
        <p>Our platform aggregates recruitment data from active CS career communities:</p>
        <div class="data-sources flex flex-wrap gap-2 mt-2">
          <span class="data-source-badge text-xs font-medium bg-slate-100 text-slate-700 px-2.5 py-0.5 rounded-full">cscareers.dev</span>
          <span class="data-source-badge text-xs font-medium bg-slate-100 text-slate-700 px-2.5 py-0.5 rounded-full">Grad Process</span>
          <span class="data-source-badge text-xs font-medium bg-slate-100 text-slate-700 px-2.5 py-0.5 rounded-full">Intern Process</span>
        </div>
      </div>

      <div class="data-section">
        <h3 class="text-base font-semibold text-slate-800 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
          Data Freshness & Coverage
        </h3>
        <ul class="list-disc list-outside pl-5 space-y-1">
          <li>Updated daily to reflect the latest submissions</li>
          <li>Most accurate data from the past 6 months</li>
          <li>Real-time processing of new entries from source platforms</li>
        </ul>
      </div>

      <div class="data-section">
        <h3 class="text-base font-semibold text-slate-800 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Data Quality & Filtering
        </h3>
        <p>We maintain high data quality through multiple validation steps:</p>
        <ul class="list-disc list-outside pl-5 space-y-1">
          <li>Automated spam detection and removal</li>
          <li>Duplicate entry identification and merging</li>
          <li>Timeline backfilling when users submit multiple interview rounds</li>
          <li>Cross-verification of submission patterns</li>
          <li>Anomaly detection for outlier data points</li>
        </ul>
      </div>

      <div class="data-section">
        <h3 class="text-base font-semibold text-slate-800 mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
          Processing & Analytics
        </h3>
        <p>Our analytics engine applies sophisticated algorithms to extract meaningful insights from raw submissions, including statistical analysis, timeline reconstruction, and conversion rate calculations.</p>
      </div>

      <div class="data-disclaimer bg-slate-100 p-3 rounded-lg border border-slate-200">
        <p><strong>Important Disclaimer:</strong> All insights and statistics presented on this dashboard are based solely on user-submitted data from our source platforms. They may not represent the complete picture of the job market or any specific company's hiring practices. Use this data as one of many resources in your job search strategy.</p>
      </div>
    </div>
  </div>
</div>

<!-- Submission Modal -->
<div class="submit-modal hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4" id="submitModal">
  <div class="modal-panel bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="modal-header flex justify-between items-center p-5 border-b border-slate-200">
      <span class="modal-title text-lg font-semibold text-slate-800">Submit interview update</span>
      <button class="modal-close text-slate-400 hover:text-slate-600" id="submitClose">&times;</button>
    </div>
    <div class="modal-body p-5">
      <div class="submit-message hidden text-sm p-3 rounded-lg mb-4" id="submitMessage"></div>
      <form id="submitForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Username *</label>
          <input type="text" id="submitUsername" placeholder="e.g. samarth" required class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Company *</label>
          <input type="text" id="submitCompany" placeholder="Company" required class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Position type *</label>
          <select id="submitPositionType" required class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
            <option value="">Select...</option>
            <option value="new_grad">New Grad</option>
            <option value="intern">Intern</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Stage *</label>
          <select id="submitStage" required class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
            <option value="">Select...</option>
            <option value="OA">OA</option>
            <option value="Phone/R1">Phone/R1</option>
            <option value="Interview">Interview</option>
            <option value="Onsite">Onsite</option>
            <option value="HM">HM</option>
            <option value="Offer">Offer</option>
            <option value="Reject">Reject</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Date *</label>
          <input type="date" id="submitDate" required min="2025-10-27" class="w-full border-slate-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
        </div>
        <p class="text-xs text-slate-500 pt-1">
          Use the same username for every submission to let us backfill your timeline automatically.
        </p>
        <button type="submit" class="feedback-submit w-full mt-2 py-2.5 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-all">Submit update</button>
      </form>
    </div>
  </div>
</div>

<!-- Share Popup -->
<div id="share-popup" class="share-popup hidden fixed bottom-6 right-6 z-[999] w-full max-w-xs bg-white rounded-xl shadow-2xl border border-slate-200 p-5">
  <div class="popup-content">
    <h3 class="text-lg font-semibold text-slate-800 mb-1">üíô Did JobStats help you?</h3>
    <p class="text-sm text-slate-600 mb-4">Share it with your friends and help more students track interview trends.</p>
    <div class="popup-buttons flex flex-col gap-2">
      <button class="share-btn w-full py-2 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-all text-sm" onclick="copyLink()">üîó Copy Link</button>
      <button class="share-btn w-full py-2 px-4 rounded-lg bg-slate-700 text-white font-medium hover:bg-slate-800 transition-all text-sm" onclick="shareLinkedIn()">üíº Share on LinkedIn</button>
      <button class="dismiss-btn w-full py-1 text-slate-500 hover:text-slate-700 text-xs mt-1" onclick="dismissPopup()">Maybe Later</button>
    </div>
  </div>
</div>

</div> <!--/ dashboard-wrapper -->

<script>
/* ------------ Globals & Helpers ------------ */
const SERVER = window.location.origin;
const $  = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

let globalCompanyCounts = {};
let META = null;
let DATA = [];
let charts = {};
let currentPage = 1;
let pageSize = 10;
let selectedCompanies = [];
let companyCounts = {};
let SESSION_ID = null;
let FILTERED_DATA = [];

function maskAuthor(name) {
  if (!name) return "";
  if (name.length <= 3) return name[0] + "**";
  return name.slice(0, 3) + "***";
}

function debounce(fn, delay) {
  let timer;
  return function (...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

function destroyChart(id) {
  if (charts[id]) {
    charts[id].destroy();
    charts[id] = null;
  }
}

function shortenStage(stage) {
  return stage;
}

async function updateCompanyPlaceholder() {
  const input = $("#companySearch");
  const start = $("#startDate")?.value;
  const end = $("#endDate")?.value;
  const newGradChecked = $("#newGradCheckbox")?.checked;
  const internChecked = $("#internCheckbox")?.checked;

  const jobTypes = [];
  if (newGradChecked) jobTypes.push("new_grad");
  if (internChecked) jobTypes.push("intern");

  const params = new URLSearchParams();
  if (start) params.append("start", start);
  if (end) params.append("end", end);
  if (jobTypes.length) params.append("job_types", jobTypes.join(","));

  try {
    const res = await fetch(`${SERVER}/api/companies/search?${params.toString()}`);
    const data = await res.json();
    const total = data.companies?.length || 0;
    input.placeholder = `Search companies (${total} available)‚Ä¶`;
  } catch (err) {
    console.error("Error updating placeholder:", err);
    input.placeholder = "Search companies‚Ä¶";
  }
}

/* ------------ Company Picker ------------ */
function renderSelectedCompanies() {
  const container = $("#selectedCompanies");
  if (!selectedCompanies.length) {
    container.classList.add("empty");
    container.innerHTML = '<span class="text-xs text-slate-500 p-1">No companies selected</span>';
    return;
  }
  container.classList.remove("empty");
  container.innerHTML = selectedCompanies
    .map(
      (c, i) =>
        `<div class="company-tag flex items-center gap-1.5 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          <span>${c}</span>
          <button class="font-bold text-blue-600 hover:text-blue-800" onclick="removeCompany(${i})">√ó</button>
        </div>`
    )
    .join("");
}
function removeCompany(index) {
  selectedCompanies.splice(index, 1);
  renderSelectedCompanies();
  currentPage = 1;
  refresh();
}
function updateCompanyCounts() {
  companyCounts = {};
  DATA.forEach((d) => {
    if (d.company) {
      companyCounts[d.company] = (companyCounts[d.company] || 0) + 1;
    }
  });
}

async function fetchCompanySuggestions(searchTerm = "") {
  const start = $("#startDate")?.value;
  const end = $("#endDate")?.value;
  const newGradChecked = $("#newGradCheckbox")?.checked;
  const internChecked = $("#internCheckbox")?.checked;

  const jobTypes = [];
  if (newGradChecked) jobTypes.push("new_grad");
  if (internChecked) jobTypes.push("intern");

  const params = new URLSearchParams();
  if (start) params.append("start", start);
  if (end) params.append("end", end);
  if (jobTypes.length) params.append("job_types", jobTypes.join(","));
  if (searchTerm) params.append("q", searchTerm);

  const res = await fetch(`${SERVER}/api/companies/search?${params.toString()}`);
  const data = await res.json();
  return data.companies || [];
}


async function renderCompanyDropdown(searchTerm) {
  const dropdown = $("#companyDropdown");
  dropdown.innerHTML = `<div class="p-3 text-sm text-slate-500">Loading...</div>`;
  dropdown.classList.remove("hidden");

  try {
    const suggestions = await fetchCompanySuggestions(searchTerm);
    const filtered = suggestions.filter(c => !selectedCompanies.includes(c.name));

    if (!filtered.length) {
      dropdown.classList.add("hidden");
      dropdown.innerHTML = "";
      return;
    }

    dropdown.innerHTML = filtered
      .slice(0, 15)
      .map(
        (c) => `
        <div class="company-option flex justify-between items-center px-3 py-2 text-sm text-slate-700 cursor-pointer hover:bg-slate-100" onclick="selectCompany('${c.name.replace(/'/g, "\\'")}')">
          <span>${c.name}</span>
          <span class="text-xs text-slate-400">(${c.count})</span>
        </div>`
      )
      .join("");
  } catch (err) {
    console.error("Error fetching companies:", err);
    dropdown.classList.add("hidden");
    dropdown.innerHTML = "";
  }
}

function selectCompany(company) {
  if (!selectedCompanies.includes(company)) {
    selectedCompanies.push(company);
    renderSelectedCompanies();
    currentPage = 1;
    refresh();
  }
  $("#companySearch").value = "";
  $("#companyDropdown").classList.add("hidden");
}

/* ------------ Metrics ------------ */
function animateCounter(element, targetValue, duration = 1500, usePlus = false) {
  const startTime = performance.now();
  const startValue = 0;
  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }
  function updateCounter(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const easedProgress = easeOutCubic(progress);
    const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
    element.textContent = currentValue.toLocaleString() + (usePlus ? '+' : '');
    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    } else {
      element.textContent = targetValue.toLocaleString() + (usePlus ? '+' : '');
    }
  }
  requestAnimationFrame(updateCounter);
}
function updateMetrics() {
  if (!META) return;
  const totalCompanies = META.companies?.length || 0;
  const roundedCompanies = Math.floor(totalCompanies / 10) * 10;
  animateCounter($("#totalCompanies"), roundedCompanies, 1500, true);

  const authorCount = META.author_count || 0;
  const roundedCandidates = Math.floor(authorCount / 100) * 100;
  animateCounter($("#totalCandidates"), roundedCandidates, 1800, true);

  const submissionCount = META.submission_count || 0;
  const roundedSubmissions = Math.floor(submissionCount / 1000) * 1000;
  animateCounter($("#totalSubmissions"), roundedSubmissions, 2000, true);

  const lastUpdatedEl = $("#lastUpdated");
  if (META.max_timestamp) {
    const maxTs = new Date(META.max_timestamp);
    const today = new Date();
    const safeDate = maxTs > today ? today : maxTs;
    const formatted = safeDate.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
    lastUpdatedEl.textContent = formatted;
  } else {
    lastUpdatedEl.textContent = "N/A";
  }
}

/* ------------ Fetchers ------------ */
async function fetchMeta() {
  const res = await fetch(`${SERVER}/api/meta`);
  META = await res.json();
  updateMetrics();
  renderSelectedCompanies();
}
async function fetchMessages(params = {}) {
  const query = new URLSearchParams(params).toString();
  const res = await fetch(`${SERVER}/api/messages?${query}`);
  const payload = await res.json();
  DATA = payload.items || [];
  applyLocalSearch();
  updateCompanyCounts();
  updateCompanyPlaceholder();
  renderTablePaginated();
  return DATA;
}

/* ------------ Table & Pagination ------------ */
function renderTablePaginated() {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  const source = FILTERED_DATA.length ? FILTERED_DATA : DATA;
  if (!source.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-3 text-sm text-slate-500 text-center">No messages found</td></tr>`;
    $("#pageInfo").textContent = `Page 0 / 0`;
    $("#prevPage").disabled = true;
    $("#nextPage").disabled = true;
    return;
  }

  const start = (currentPage - 1) * pageSize;
  const pageItems = source.slice(start, start + pageSize);

  for (const m of pageItems) {
    const tr = document.createElement("tr");
    const t = m.timestamp ? new Date(m.timestamp).toLocaleString() : "‚Äî";
    tr.innerHTML = `
      <td class="px-4 py-2 text-sm text-slate-600 whitespace-nowrap">${t}</td>
      <td class="px-4 py-2 text-sm text-slate-800 font-medium whitespace-nowrap">${m.company || ""}</td>
      <td class="px-4 py-2 text-sm text-slate-600 whitespace-nowrap">${m.stage || ""}</td>
      <td class="px-4 py-2 text-sm text-slate-600 whitespace-nowrap">${maskAuthor(m.author)}</td>
      <td class="px-4 py-2 text-sm text-slate-600 max-w-xs truncate">${m.text || ""}</td>
    `;
    tbody.appendChild(tr);
  }

  const totalPages = Math.ceil(source.length / pageSize) || 1;
  $("#pageInfo").textContent = `Page ${currentPage} / ${totalPages}`;
  $("#prevPage").disabled = currentPage === 1;
  $("#nextPage").disabled = currentPage === totalPages;
}

function applyLocalSearch() {
  const c = $("#searchCompany").value.trim().toLowerCase();
  const a = $("#searchAuthor").value.trim().toLowerCase();
  const s = $("#searchStage").value.trim().toLowerCase();

  let filtered = DATA;
  if (c) filtered = filtered.filter(m => (m.company || "").toLowerCase().includes(c));
  if (a) filtered = filtered.filter(m => (m.author || "").toLowerCase().includes(a));
  if (s) filtered = filtered.filter(m => (m.stage || "").toLowerCase().includes(s));

  FILTERED_DATA = filtered;
  currentPage = 1;
  renderTablePaginated();
}

["searchCompany", "searchAuthor", "searchStage"].forEach(id => {
  const input = document.getElementById(id);
  input.addEventListener("input", debounce(applyLocalSearch, 200));
});

$("#prevPage").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderTablePaginated();
  }
});

$("#nextPage").addEventListener("click", () => {
  const source = FILTERED_DATA.length ? FILTERED_DATA : DATA;
  const totalPages = Math.ceil(source.length / pageSize) || 1;
  if (currentPage < totalPages) {
    currentPage++;
    renderTablePaginated();
  }
});

/* ------------ Chart Renderers ------------ */

function renderFunnel(order, counts) {
  const rows = document.getElementById("funnelRows");
  const scale = document.getElementById("funnelScale");

  if (!rows || !scale) {
    console.warn("‚ùó Funnel DOM elements not found");
    return;
  }

  rows.innerHTML = "";
  scale.innerHTML = "";

  const maxCount = Math.max(...order.map(s => counts[s] || 0), 1);

  // Render bars
  order.forEach(stage => {
    const count = counts[stage] || 0;
    const percent = ((count / maxCount) * 100).toFixed(1) + "%";
    const row = document.createElement("div");
    row.className = "funnel-row flex items-center gap-3";
    row.innerHTML = `
      <span class="funnel-label w-20 text-sm text-slate-700 truncate">${stage}</span>
      <div class="funnel-bar flex-1 h-2.5 bg-slate-100 rounded-full overflow-hidden">
        <div class="funnel-fill h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-700 ease-out" style="width:${percent}"></div>
      </div>
    `;
    rows.appendChild(row);
  });

  // Render dynamic scale
  const tickCount = 6;
  const step = maxCount / (tickCount - 1);

  const scaleContainer = document.createElement('div');
  scaleContainer.className = "flex justify-between text-xs text-slate-400 mt-2 ml-[88px]"; // 80px width + 8px gap

  for (let i = 0; i < tickCount; i++) {
    const val = Math.round(i * step);
    const tick = document.createElement("span");
    tick.textContent = val.toLocaleString();
    if (i > 0 && i < tickCount - 1) tick.className = "flex-1 text-center";
    if (i === 0) tick.className = "text-left";
    if (i === tickCount - 1) tick.className = "text-right";
    scaleContainer.appendChild(tick);
  }
  scale.appendChild(scaleContainer);
}

function renderHeatmap(sel, companies, transitions, convMat) {
  const svg = d3.select(sel);
  svg.selectAll("*").remove();
  if (!companies.length || !transitions.length) return;

  const margin = { top: 20, right: 80, bottom: 50, left: 100 };
  const W = svg.node().getBoundingClientRect().width;
  const H = Math.min(W * 0.56, 400); // 16:9 aspect ratio, max 400px
  svg.attr("height", H); // Set explicit height

  const w = Math.max(0, W - margin.left - margin.right);
  const h = Math.max(0, H - margin.top - margin.bottom);
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const y = d3.scaleBand().domain(companies).range([0, h]).padding(0.15);
  const shortTransitions = transitions.map((t) => {
    if (t === "Overall‚ÜíReject") return t;
    const parts = t.split("‚Üí");
    return `${shortenStage(parts[0])}‚Üí${shortenStage(parts[1])}`;
  });
  const x = d3.scaleBand().domain(shortTransitions).range([0, w]).padding(0.15);
  const color = d3.scaleSequential(d3.interpolateBlues).domain([0, 100]);

  g.append("g")
    .attr("transform", `translate(0,${h})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("transform", "rotate(25)")
    .style("text-anchor", "start");

  g.append("g").call(d3.axisLeft(y));

  companies.forEach((c) =>
    transitions.forEach((t, i) => {
      const val = convMat[c]?.[t] ?? 0;
      const shortT = shortTransitions[i];
      g.append("rect")
        .attr("x", x(shortT))
        .attr("y", y(c))
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .attr("rx", 4)
        .attr("fill", color(val))
        .append("title")
        .text(`${c} ${t}: ${val.toFixed(1)}%`);
    })
  );

  const legendWidth = 20;
  const legendHeight = Math.max(40, h);
  const legendX = w + 20;
  const legendScale = d3.scaleLinear().domain([0, 100]).range([legendHeight, 0]);
  const legendAxis = d3.axisRight(legendScale).ticks(5).tickFormat((d) => `${d}%`);

  const defs = svg.append("defs");
  const gradId = "heatmap-gradient";
  const gradient = defs.append("linearGradient").attr("id", gradId).attr("x1", "0%").attr("y1", "100%").attr("x2", "0%").attr("y2", "0%");
  for (let i = 0; i <= 100; i += 10) {
    gradient.append("stop").attr("offset", `${i}%`).attr("stop-color", color(i));
  }

  g.append("rect")
    .attr("x", legendX)
    .attr("y", 0)
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .attr("rx", 4)
    .style("fill", `url(#${gradId})`);

  g.append("g")
    .attr("transform", `translate(${legendX + legendWidth},0)`)
    .call(legendAxis);

  g.append("text")
    .attr("x", legendX + legendWidth / 2)
    .attr("y", -5)
    .style("font-size", "11px")
    .style("font-weight", "600")
    .attr("text-anchor", "middle")
    .text("Conv %");
}

function renderTimeline(sel, transitionsForTimeline, stageTimes) {
  const svg = d3.select(sel);
  svg.selectAll("*").remove();
  if (!transitionsForTimeline.length) return;

  const margin = { top: 30, right: 30, bottom: 50, left: 140 };
  const W = svg.node().getBoundingClientRect().width;
  const H = Math.min(W * 0.56, 400); // 16:9 aspect ratio, max 400px
  svg.attr("height", H); // Set explicit height

  const w = Math.max(0, W - margin.left - margin.right);
  const h = Math.max(0, H - margin.top - margin.bottom);
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const rows = transitionsForTimeline.map((key) => {
    const days = Math.round(stageTimes[key] || 0);
    const label = key === "Overall‚ÜíReject" ? key : key.split("‚Üí").map(shortenStage).join("‚Üí");
    return { key, days, label };
  });

  if (!rows.some(r => r.days > 0)) return;

  const y = d3.scaleBand().domain(rows.map(r => r.label)).range([0, h]).padding(0.2);
  const maxDays = d3.max(rows, r => r.days) || 0;
  const x = d3.scaleLinear()
    .domain([0, maxDays + 1])
    .nice()
    .range([0, w]);

  const color = d3.scaleSequential(d3.interpolateViridis).domain([0, rows.length - 1]);

  g.append("g").call(d3.axisLeft(y));

  const xAxis = g.append("g").attr("transform", `translate(0,${h})`).call(d3.axisBottom(x).ticks(5));
  xAxis.append("text")
    .attr("x", w / 2)
    .attr("y", 35)
    .attr("fill", "currentColor")
    .style("text-anchor", "middle")
    .style("font-size", "11px")
    .style("font-weight", "600")
    .text("Days");

  rows.forEach((r, i) => {
    g.append("rect")
      .attr("x", 0)
      .attr("y", y(r.label))
      .attr("width", x(r.days))
      .attr("height", y.bandwidth())
      .attr("rx", 4)
      .attr("fill", color(i))
      .append("title")
      .text(`${r.key}: ${r.days} days`);

    g.append("text")
      .attr("x", x(r.days) + 5)
      .attr("y", y(r.label) + y.bandwidth() / 2 + 4)
      .style("font-size", "11px")
      .attr("fill", "currentColor")
      .text(`${r.days}d`);
  });
}

function renderBarLine(stages, counts) {
  destroyChart("barline");
  const ctx = document.getElementById("barline");
  if (!ctx) return;
  const vals = stages.map((s) => counts[s] || 0);
  if (!vals.some((v) => v > 0)) return;

  const cumulative = [];
  let sum = 0;
  for (const v of vals) {
    sum += v;
    cumulative.push(sum);
  }

  const textColor = '#334155'; // slate-700
  const gridColor = '#e2e8f0'; // slate-200
  const labels = stages.map((s) => shortenStage(s));

  charts.barline = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Count",
          data: vals,
          backgroundColor: "rgba(59, 130, 246, 0.8)", // blue-500
          borderRadius: 6,
          barPercentage: 0.8,
          categoryPercentage: 0.7,
          yAxisID: "y",
        },
        {
          label: "Cumulative",
          type: "line",
          data: cumulative,
          borderColor: "#f59e0b", // amber-500
          borderWidth: 3,
          fill: false,
          tension: 0.25,
          pointBackgroundColor: "#f59e0b",
          pointRadius: 4,
          pointHoverRadius: 5,
          yAxisID: "y1",
        },
      ],
    },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: "top",
          labels: { color: textColor, font: { size: 12, weight: 500 }, boxWidth: 14 },
        },
        tooltip: {
          backgroundColor: "rgba(15, 23, 42, 0.9)", // slate-900
          titleFont: { size: 13, weight: 600 },
          bodyFont: { size: 12 },
          padding: 10,
          borderColor: "rgba(255,255,255,0.1)",
          borderWidth: 1,
          usePointStyle: true,
        },
      },
      scales: {
        x: {
          ticks: { color: textColor, font: { size: 12, weight: 500 } },
          grid: { color: gridColor, drawBorder: false },
        },
        y: {
          beginAtZero: true,
          ticks: { color: textColor, font: { size: 12, weight: 500 } },
          grid: { color: gridColor, drawBorder: false },
          title: { display: true, text: "Count", color: textColor, font: { weight: 600 } },
        },
        y1: {
          beginAtZero: true,
          position: "right",
          grid: { drawOnChartArea: false },
          ticks: { color: textColor, font: { size: 12, weight: 500 } },
          title: { display: true, text: "Cumulative", color: textColor, font: { weight: 600 } },
        },
      },
      animation: { duration: 700, easing: "easeOutQuart" },
    },
  });
}

function renderCompanyCards(sel, companies) {
  const container = document.querySelector(sel);
  container.innerHTML = '';

  if (!companies || companies.length === 0) {
    container.innerHTML = '<div class="p-2 text-sm text-slate-500">No data available</div>';
    return;
  }

  companies.forEach((company, index) => {
    const card = document.createElement('div');
    card.className = 'company-card-item flex items-center justify-between gap-3 p-2.5 rounded-lg bg-slate-50 hover:bg-slate-100 border border-slate-200/75 hover:shadow-md transition-all cursor-pointer';
    card.setAttribute('data-company', company.company);
    card.innerHTML = `
      <div class="company-card-content flex items-center gap-3 flex-1 min-w-0">
        <div class="company-rank text-sm font-medium text-slate-500 w-6 text-right">#${index + 1}</div>
        <div class="company-card-name text-sm font-medium text-slate-800 truncate">${company.company}</div>
      </div>
      <div class="company-card-count text-sm font-semibold text-blue-700 bg-blue-100 px-3 py-0.5 rounded-full">${company.count}</div>
    `;
    card.addEventListener('click', () => {
      if (!selectedCompanies.includes(company.company)) {
        selectedCompanies.push(company.company);
        renderSelectedCompanies();
        currentPage = 1;
        refresh();
      }
    });
    container.appendChild(card);
  });
}

async function renderTopOACompanies() {
  const container = $("#topOACompanies");
  container.innerHTML = '<div class="p-2 text-sm text-slate-500">Loading...</div>';

  try {
    const newGradChecked = $("#newGradCheckbox").checked;
    const internChecked = $("#internCheckbox").checked;
    const jobTypes = [];
    if (newGradChecked) jobTypes.push("new_grad");
    if (internChecked) jobTypes.push("intern");

    const params = new URLSearchParams();
    if (jobTypes.length > 0) {
      params.append('job_types', jobTypes.join(','));
    }

    const res = await fetch(`${SERVER}/api/top-oa-companies?${params}`);
    const data = await res.json();

    if (!data.companies || data.companies.length === 0) {
      container.innerHTML = '<div class="p-2 text-sm text-slate-500">No OA data available for this week</div>';
      return;
    }
    renderCompanyCards("#topOACompanies", data.companies);
  } catch (error) {
    console.error('Failed to fetch top OA companies:', error);
    container.innerHTML = '<div class="p-2 text-sm text-red-600">Failed to load data</div>';
  }
}

async function renderTopOfferCompanies() {
  const container = $("#topOfferCompanies");
  container.innerHTML = '<div class="p-2 text-sm text-slate-500">Loading...</div>';

  try {
    const newGradChecked = $("#newGradCheckbox").checked;
    const internChecked = $("#internCheckbox").checked;
    const jobTypes = [];
    if (newGradChecked) jobTypes.push("new_grad");
    if (internChecked) jobTypes.push("intern");

    const params = new URLSearchParams();
    if (jobTypes.length > 0) {
      params.append('job_types', jobTypes.join(','));
    }

    const res = await fetch(`${SERVER}/api/top-offer-companies?${params}`);
    const data = await res.json();

    if (!data.companies || data.companies.length === 0) {
      container.innerHTML = '<div class="p-2 text-sm text-slate-500">No offer data available for this week</div>';
      return;
    }
    renderCompanyCards("#topOfferCompanies", data.companies);
  } catch (error) {
    console.error('Failed to fetch top offer companies:', error);
    container.innerHTML = '<div class="p-2 text-sm text-red-600">Failed to load data</div>';
  }
}

async function renderHiringTrends() {
  const canvas = $("#hiringTrends");
  if (!canvas) return;
  const container = canvas.parentElement;
  container.style.opacity = '0.6';

  try {
    const newGradChecked = $("#newGradCheckbox").checked;
    const internChecked = $("#internCheckbox").checked;
    const jobTypes = [];
    if (newGradChecked) jobTypes.push("new_grad");
    if (internChecked) jobTypes.push("intern");

    const params = new URLSearchParams();
    if (jobTypes.length > 0) {
      params.append('job_types', jobTypes.join(','));
    }
    if (selectedCompanies.length === 1) {
      params.append('company', selectedCompanies[0]);
    }

    const res = await fetch(`${SERVER}/api/hiring-trends?${params}`);
    const response = await res.json();

    if (!response.companies || Object.keys(response.companies).length === 0) {
      container.style.opacity = '1';
      return;
    }

    destroyChart("hiringTrends");

    const textColor = '#334155'; // slate-700
    const gridColor = '#e2e8f0'; // slate-200

    const colorPalette = [
      { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' }, // blue
      { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }, // red
      { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' }, // green
      { border: '#f97316', bg: 'rgba(249, 115, 22, 0.1)' }, // orange
      { border: '#a855f7', bg: 'rgba(168, 85, 247, 0.1)' } // purple
    ];

    const globalAverageStyle = {
      border: '#475569', // slate-600
      bg: 'rgba(71, 85, 105, 0.05)'
    };

    const allDates = new Set();
    Object.values(response.companies).forEach(companyData => {
      companyData.forEach(item => allDates.add(item.date));
    });

    const sortedDates = Array.from(allDates).sort();
    const labels = sortedDates.map(dateStr => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const datasets = [];
    const isSingle = selectedCompanies.length === 1;

    if (isSingle) {
      const stageColors = {
        "OA": "#3b82f6",
        "Phone/R1": "#ef4444",
        "Interview": "#22c55e",
        "Onsite": "#f97316",
        "HM": "#a855f7",
        "Offer": "#8b5cf6" // violet
      };

      Object.keys(response.companies).forEach(stage => {
        const stageData = response.companies[stage];
        const dataMap = {};
        stageData.forEach(i => dataMap[i.date] = i.count);
        const data = sortedDates.map(date => ({
          x: new Date(date + "T00:00:00Z"),
          y: dataMap[date] || null
        }));

        datasets.push({
          label: stage,
          data,
          borderColor: stageColors[stage] || "#64748b",
          backgroundColor: "transparent",
          borderWidth: 2.4,
          tension: 0.2,
          pointRadius: 0,
          spanGaps: true
        });
      });

    } else {
      const companies = Object.keys(response.companies);
      let regularCompanyIndex = 0;

      companies.forEach(company => {
        const companyData = response.companies[company];
        const dataMap = {};
        companyData.forEach(item => dataMap[item.date] = item.count);
        const data = sortedDates.map(date => ({
          x: new Date(date + 'T00:00:00Z'),
          y: dataMap[date] || null
        }));

        if (company === 'Global Average') {
          datasets.push({
            label: company,
            data,
            borderColor: globalAverageStyle.border,
            backgroundColor: globalAverageStyle.bg,
            borderWidth: 3,
            borderDash: [10,5],
            fill: false,
            tension: 0.2,
            pointRadius: 0,
            spanGaps: true,
            order: 0
          });
        } else {
          const colors = colorPalette[regularCompanyIndex % colorPalette.length];
          regularCompanyIndex++;

          datasets.push({
            label: company,
            data,
            borderColor: colors.border,
            backgroundColor: colors.bg,
            borderWidth: 2.3,
            fill: false,
            tension: 0.2,
            pointRadius: 0,
            spanGaps: true,
            order: 1
          });
        }
      });
    }

    const ctx = canvas.getContext('2d');
    charts.hiringTrends = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            labels: { color: textColor, usePointStyle: true, font: { size: 12 } }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(15, 23, 42, 0.9)',
            titleFont: { size: 13, weight: 600 },
            bodyFont: { size: 12 },
            padding: 10,
            usePointStyle: true,
          }
        },
        scales: {
          x: {
            type: 'time',
            min: new Date(Date.now() - 180 * 24 * 60 * 60 * 1000), // last 6 months
            max: new Date(),
            time: {
              unit: 'week',
              displayFormats: { week: 'MMM d', month: 'MMM' }
            },
            ticks: { color: textColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 15, font: { size: 12 } },
            grid: { color: gridColor }
          },
          y: {
            beginAtZero: true,
            ticks: { color: textColor, font: { size: 12 } },
            grid: { color: gridColor }
          }
        },
        interaction: { mode: 'index', axis: 'x', intersect: false },
        animation: { duration: 700 }
      }
    });

    container.style.opacity = '1';
  } catch (error) {
    console.error('Failed to fetch hiring trends:', error);
    container.style.opacity = '1';
  }
}

/* ------------ Refresh (main orchestrator) ------------ */
async function refresh() {
  const loader = document.getElementById("refreshLoader");
  loader.classList.remove("hidden");
  $("#companySearch").disabled = true;

  try {
    const start = $("#startDate").value;
    const end = $("#endDate").value;
    const newGradChecked = $("#newGradCheckbox").checked;
    const internChecked = $("#internCheckbox").checked;

    const jobTypes = [];
    if (newGradChecked) jobTypes.push("new_grad");
    if (internChecked) jobTypes.push("intern");

    const params = { start, end };
    if (selectedCompanies.length) {
      params.companies = selectedCompanies.join(",");
    }
    if (jobTypes.length > 0) {
      params.job_types = jobTypes.join(",");
    }

    const data = await fetchMessages(params);

    const stages = META.stages || [];
    const counts = Object.fromEntries(stages.map((s) => [s, 0]));
    data.forEach((d) => {
      if (counts[d.stage] != null) counts[d.stage]++;
    });

    const baseCompanies = selectedCompanies.length ? selectedCompanies : META.companies || [];
    const compCounts = {};
    baseCompanies.forEach((c) => (compCounts[c] = 0));
    data.forEach((d) => {
      if (compCounts[d.company] != null) compCounts[d.company]++;
    });
    const top8Companies = Object.entries(compCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8)
      .map(([c]) => c);

    const convMat = {};
    const applications = {};
    data.forEach((d) => {
      const key = `${d.company}|${d.author}`;
      (applications[key] ||= []).push({
        stage: d.stage,
        ts: d.timestamp ? new Date(d.timestamp).getTime() : null,
      });
    });

    const userStages = {};
    Object.entries(applications).forEach(([key, msgs]) => {
      const stagesSeen = new Set(msgs.map(m => m.stage).filter(Boolean));
      userStages[key] = stagesSeen;
    });

    top8Companies.forEach((c) => {
      convMat[c] = {};
      const companyUsers = Object.keys(userStages).filter(k => k.startsWith(`${c}|`));
      for (let i = 0; i < stages.length - 1; i++) {
        const from = stages[i];
        const to = stages[i + 1];
        if ((to || "").toLowerCase() === "reject") continue;
        const fromCount = companyUsers.filter(k => userStages[k].has(from)).length;
        const toCount = companyUsers.filter(k => userStages[k].has(from) && userStages[k].has(to)).length;
        const pct = fromCount > 0 ? (toCount / fromCount) * 100 : 0;
        convMat[c][`${from}‚Üí${to}`] = pct;
      }
    });

    const appsByCompany = {};
    top8Companies.forEach((c) => (appsByCompany[c] = new Set()));
    Object.keys(applications).forEach((key) => {
      const [company] = key.split("|");
      if (appsByCompany[company]) appsByCompany[company].add(key);
    });
    top8Companies.forEach((c) => {
      const keys = Array.from(appsByCompany[c] || []);
      if (!keys.length) {
        convMat[c]["Overall‚ÜíReject"] = 0;
        return;
      }
      let rejected = 0;
      keys.forEach((k) => {
        const stagesSeen = new Set((applications[k] || []).map((x) => x.stage).filter(Boolean));
        if (stagesSeen.has("Reject")) rejected += 1;
      });
      convMat[c]["Overall‚ÜíReject"] = (rejected / keys.length) * 100;
    });

    const transitionDays = {};
    stages.slice(0, -1).forEach((s, i) => {
      const to = stages[i + 1];
      transitionDays[`${s}‚Üí${to}`] = [];
    });

    const appEarliest = {};
    Object.entries(applications).forEach(([key, msgs]) => {
      const stageMap = {};
      msgs.forEach((m) => {
        if (!m.stage || !Number.isFinite(m.ts)) return;
        if (!(m.stage in stageMap) || m.ts < stageMap[m.stage]) {
          stageMap[m.stage] = m.ts;
        }
      });
      appEarliest[key] = stageMap;
    });

    Object.values(appEarliest).forEach((stageMap) => {
      for (let i = 0; i < stages.length - 1; i++) {
        const from = stages[i], to = stages[i + 1];
        if (stageMap[from] != null && stageMap[to] != null) {
          const days = (stageMap[to] - stageMap[from]) / (1000 * 60 * 60 * 24);
          if (Number.isFinite(days) && days >= 0) transitionDays[`${from}‚Üí${to}`].push(days);
        }
      }
    });

    const HM = "HM";
    const REJECT = "Reject";
    const hmToRejectDays = [];
    Object.values(appEarliest).forEach((stageMap) => {
      if (stageMap[HM] != null && stageMap[REJECT] != null) {
        const days = (stageMap[REJECT] - stageMap[HM]) / (1000 * 60 * 60 * 24);
        if (Number.isFinite(days) && days >= 0) hmToRejectDays.push(days);
      }
    });

    const stageTimes = {};
    Object.keys(transitionDays).forEach((k) => {
      const arr = transitionDays[k];
      stageTimes[k] = arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    });
    stageTimes["Overall‚ÜíReject"] = hmToRejectDays.length
      ? hmToRejectDays.reduce((a, b) => a + b, 0) / hmToRejectDays.length
      : 0;

    const transitions = stages
      .slice(0, -1)
      .filter((_, i) => (stages[i + 1] || "").toLowerCase() !== "reject")
      .map((_, i) => `${stages[i]}‚Üí${stages[i + 1]}`);

    const transitionsWithOverallReject = [...transitions, "Overall‚ÜíReject"];

    renderFunnel(stages, counts);
    renderHeatmap("#heatmap", top8Companies, transitionsWithOverallReject, convMat);
    renderTimeline("#timeline", transitionsWithOverallReject, stageTimes);
    renderBarLine(stages, counts);
    renderTopOACompanies();
    renderTopOfferCompanies();
    renderHiringTrends();
  } catch (error) {
    console.error("Error during refresh:", error);
  } finally {
    loader.classList.add("hidden");
    $("#companySearch").disabled = false;
  }
}

/* ------------ Session Tracking ------------ */
function generateSessionId() {
  let sessionId = localStorage.getItem('viewer_session_id');
  if (!sessionId) {
    sessionId = `session_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
    localStorage.setItem('viewer_session_id', sessionId);
  }
  return sessionId;
}
async function startSession() {
  SESSION_ID = generateSessionId();
  try {
    await fetch(`${SERVER}/api/session/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: SESSION_ID })
    });
  } catch (error) {
    console.error('Failed to start session:', error);
  }
}
async function sendHeartbeat() {
  if (!SESSION_ID) return;
  try {
    await fetch(`${SERVER}/api/session/heartbeat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: SESSION_ID })
    });
  } catch (error) {
    console.error('Failed to send heartbeat:', error);
  }
}
async function updateViewerCount() {
  try {
    const res = await fetch(`${SERVER}/api/viewers/count`);
    const data = await res.json();
    $("#viewerCount").textContent = data.count || 0;
  } catch (error) {
    console.error('Failed to fetch viewer count:', error);
    $("#viewerCount").textContent = '-';
  }
}
function initSessionTracking() {
  startSession();
  updateViewerCount();
  setInterval(sendHeartbeat, 30000);
  setInterval(updateViewerCount, 30000);
}

/* ------------ Modals ------------ */
function initFeedbackModal() {
  const modal = $("#feedbackModal");
  const openBtn = $("#feedbackBtn");
  const closeBtn = $("#feedbackClose");
  const cancelBtn = $("#feedbackCancel");
  const form = $("#feedbackForm");
  const statusEl = $("#feedbackStatus");
  const ratingButtons = $$(".rating-btn");
  const ratingInput = $("#feedbackRating");

  const open = () => {
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  };
  const close = () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
    form.reset();
    statusEl.className = "feedback-status hidden";
    statusEl.textContent = "";
    ratingButtons.forEach(btn => btn.dataset.selected = 'false');
    ratingInput.value = "";
  };

  openBtn.addEventListener("click", open);
  closeBtn.addEventListener("click", close);
  cancelBtn.addEventListener("click", close);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) close();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) close();
  });

  ratingButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      ratingButtons.forEach(b => b.dataset.selected = 'false');
      btn.dataset.selected = 'true';
      ratingInput.value = btn.getAttribute("data-rating");
    });
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const feedbackText = $("#feedbackText").value.trim();
    const email = $("#feedbackEmail").value.trim();
    const rating = ratingInput.value;

    if (!feedbackText) {
      statusEl.className = "feedback-status block bg-red-100 text-red-700 p-3 rounded-lg";
      statusEl.textContent = "Please share some feedback.";
      return;
    }

    const submitBtn = form.querySelector(".feedback-submit");
    submitBtn.disabled = true;
    submitBtn.textContent = "Sending...";

    try {
      const res = await fetch(`${SERVER}/api/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          feedback: feedbackText,
          email: email || null,
          rating: rating ? parseInt(rating) : null,
          session_id: SESSION_ID
        })
      });
      const data = await res.json();
      if (res.ok && data.success) {
        statusEl.className = "feedback-status block bg-green-100 text-green-700 p-3 rounded-lg";
        statusEl.textContent = "Thanks ‚Äî feedback saved.";
        setTimeout(() => close(), 1800);
      } else {
        throw new Error(data.error || "Failed to submit");
      }
    } catch (error) {
      console.error("Feedback submission error:", error);
      statusEl.className = "feedback-status block bg-red-100 text-red-700 p-3 rounded-lg";
      statusEl.textContent = "Failed to submit, please try again.";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Send";
    }
  });
}

function initDataModal() {
  const modal = $("#dataModal");
  const openBtn = $("#dataInfoBtn");
  const closeBtn = $("#dataClose");

  const open = () => {
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  };
  const close = () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  };

  openBtn.addEventListener("click", open);
  closeBtn.addEventListener("click", close);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) close();
  });
}

function initSubmitModal() {
  const modal = $("#submitModal");
  const submitClose = $("#submitClose");
  const form = $("#submitForm");
  const message = $("#submitMessage");

  const close = () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
    form.reset();
    message.className = "submit-message hidden";
  };

  submitClose.addEventListener("click", close);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) close();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
      close();
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      username: $("#submitUsername").value.trim(),
      company: $("#submitCompany").value.trim(),
      position_type: $("#submitPositionType").value,
      stage: $("#submitStage").value,
      date: $("#submitDate").value
    };
    const submitButton = form.querySelector(".feedback-submit");
    submitButton.disabled = true;
    submitButton.textContent = "Submitting...";

    try {
      const res = await fetch(`${SERVER}/api/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const data = await res.json();

      if (res.ok && data.success) {
        message.className = "submit-message block bg-green-100 text-green-700 p-3 rounded-lg";
        message.textContent = "Interview update submitted!";
        setTimeout(() => close(), 1500);
      } else {
        throw new Error(data.error || "Failed to submit");
      }
    } catch (error) {
      console.error("Submission error:", error);
      message.className = "submit-message block bg-red-100 text-red-700 p-3 rounded-lg";
      message.textContent = "Failed to submit. Please try again.";
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "Submit update";
    }
  });
}

/* ------------ Share Popup ------------ */
function showSharePopup() {
  $("#share-popup").classList.remove("hidden");
}
function dismissPopup() {
  $("#share-popup").classList.add("hidden");
}
function copyLink() {
  navigator.clipboard.writeText("https://jobstats.fyi");
  alert("Copied! Thanks for helping others üíô");
  dismissPopup();
}
function shareLinkedIn() {
  const url = encodeURIComponent("https://jobstats.fyi");
  window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, "_blank");
  dismissPopup();
}

/* ------------ Init ------------ */
async function initDashboard() {
  const today = new Date();
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(today.getMonth() - 3);

  const fmt = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  };

  $("#startDate").value = fmt(threeMonthsAgo);
  $("#endDate").value = fmt(today);

  await fetchMeta();

  if (META && META.company_counts) {
    globalCompanyCounts = META.company_counts;
  } else if (META && META.company_data) {
    globalCompanyCounts = META.company_data.reduce((acc, d) => {
      const name = d.company;
      acc[name] = (acc[name] || 0) + 1;
      return acc;
    }, {});
  } else if (META && META.companies) {
    META.companies.forEach(c => globalCompanyCounts[c] = 0);
  }

  await fetchMessages();
  updateCompanyPlaceholder();
  await refresh();

  renderTopOACompanies();
  renderTopOfferCompanies();

  $$(".date-preset-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const days = parseInt(btn.getAttribute("data-days"));
      const today = new Date();
      const pastDate = new Date();
      pastDate.setDate(today.getDate() - days);
      $("#startDate").value = fmt(pastDate);
      $("#endDate").value = fmt(today);
      $$(".date-preset-btn").forEach(b => b.dataset.active = 'false');
      btn.dataset.active = 'true';
      currentPage = 1;
      refresh();
    });
  });

  const debouncedCompanySearch = debounce((e) => {
    renderCompanyDropdown(e.target.value);
  }, 300);

  $("#companySearch").addEventListener("input", debouncedCompanySearch);
  $("#companySearch").addEventListener("focus", (e) => renderCompanyDropdown(e.target.value));

  $("#applyBtn").addEventListener("click", () => {
    currentPage = 1;
    refresh();
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".company-search-wrapper")) {
      $("#companyDropdown").classList.add("hidden");
    }
  });

  ["#newGradCheckbox", "#internCheckbox"].forEach(id => {
    document.querySelector(id).addEventListener("change", (event) => {
      const newGrad = document.querySelector("#newGradCheckbox");
      const intern = document.querySelector("#internCheckbox");
      if (!newGrad.checked && !intern.checked) {
        event.target.checked = true;
        return;
      }
      currentPage = 1;
      refresh();
    });
  });

  initSessionTracking();
  initFeedbackModal();
  initDataModal();
  initSubmitModal();

  // Share Popup Logic
  const shownRecently = localStorage.getItem("popupShownTime");
  const now = Date.now();
  if ((!shownRecently || now - shownRecently > 7 * 24 * 60 * 60 * 1000) && Math.random() < 0.3) {
    setTimeout(() => {
      showSharePopup();
      localStorage.setItem("popupShownTime", now);
    }, 10000);
  }
}

window.addEventListener("DOMContentLoaded", initDashboard);
window.removeCompany = removeCompany;
window.selectCompany = selectCompany;
</script>

</body>
</html>